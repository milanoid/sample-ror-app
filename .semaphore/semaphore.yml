version: v1.0
name: Rails Sample Build
agent:
  machine:
    type: s1-runner01
    os_image: ''
  containers:
    - name: main
      image: 'ghcr.io/milanoid/semaphore-agent:1.0.0'
      env_vars:
        - name: RAILS_ENV
          value: test
execution_time_limit:
  hours: 2
queue:
  processing: parallel
auto_cancel:
  queued:
    when: 'true'
global_job_config:
  prologue:
    commands:
      - checkout
#      - cp ../master.key ./config/master.key
      - cache restore
#     https://docs.semaphore.io/using-semaphore/self-hosted#limtations
#      - sem-version c 9
#      - sem-version ruby 3.4.8
      # source to make 'nvm' shell function available in non-interactive shell
      - source ~/.nvm/nvm.sh && nvm use stable
      - gem install bundler -v 2.7.2
      - bundle config set --local deployment 'true'
      - bundle config set --local path 'vendor/bundle'
      - bundle install
      #      - sem-service start postgres 15
      #      - psql -U postgres -h localhost -c "CREATE USER runner WITH PASSWORD 'semaphoredb';"
      #      - psql -U postgres -h localhost -c "ALTER USER runner WITH SUPERUSER;"
      #      - 'bundle exec rake db:setup'
      #      - 'bundle exec rake db:test:prepare'
      - bundle exec yarn install --check-files
      - 'bundle exec rake assets:precompile'
      - cache store
blocks:
  - name: Cucumber
    dependencies: []
    task:
      env_vars:
        - name: TEST_TYPE
          value: cucumber
        - name: RAILS_ENV
          value: test
#      secrets:
#        - name: Environment variables
#        - name: Klient secrets
      jobs:
        - name: Cucumber
          commands:
            - bundle exec cucumber --format junit --out cucumber.xml
      epilogue:
        always:
          commands:
            - test-results publish cucumber.xml
  - name: RSpec
    dependencies: []
    task:
      env_vars:
        - name: TEST_TYPE
          value: rspec
        - name: RAILS_ENV
          value: test
#      secrets:
#        - name: Environment variables
#        - name: Klient secrets
      jobs:
        - name: RSpec
          commands:
            - bundle exec rspec --format RspecJunitFormatter --out rspec.xml
      epilogue:
        always:
          commands:
            - test-results publish rspec.xml
after_pipeline:
  task:
    jobs:
      - name: Publish Results
        commands:
          - test-results gen-pipeline-report
