version: v1.0
name: Rails Sample Build
agent:
  machine:
    type: s1-runner01
    os_image: ''
#  containers:
#    - name: main
#      image: 'registry.semaphoreci.com/ruby:3.2.0'
#      env_vars:
#        - name: RAILS_ENV
#          value: test
execution_time_limit:
  hours: 2
queue:
  processing: parallel
auto_cancel:
  queued:
    when: 'true'
global_job_config:
  prologue:
    commands:
      - checkout
#      - cp ../master.key ./config/master.key
      - cache restore
#     https://docs.semaphore.io/using-semaphore/self-hosted#limtations
#      - sem-version c 9
#      - sem-version ruby 3.4.8
      - nvm use stable
      - gem install bundler -v 2.7.2
      - bundle config set --local deployment 'true'
      - bundle config set --local path 'vendor/bundle'
      - bundle install
      #      - sem-service start postgres 15
      #      - psql -U postgres -h localhost -c "CREATE USER runner WITH PASSWORD 'semaphoredb';"
      #      - psql -U postgres -h localhost -c "ALTER USER runner WITH SUPERUSER;"
      #      - 'bundle exec rake db:setup'
      #      - 'bundle exec rake db:test:prepare'
      - bundle exec yarn install --check-files
      - 'bundle exec rake assets:precompile'
      - cache store
blocks:
  - name: Build
    task:
      prologue:
        commands:
          - whoami
          - cat /etc/os-release
          - pwd
          - ls -la
          - ps aux | grep "agent"
          - checkout
          - ls -la
          - ruby --version
          - gem --version
      jobs:
        - name: Bundle Install
          commands:
            - bundle install --jobs=4 --retry=3
            - bundle exec rails --version
            - echo "Rails setup completed successfully!"
